V(function(){var indexOf=[].indexOf||function(item){for(var i=0,l=this.length;i<l;i++){if(i in this&&this[i]===item)return i;}return-1;};$(function(){var Topic;Topic=(function(){function Topic(pk){var initialURL,popped,socket,topic;this.first_load=true;this.pk=pk;topic=this;this.page=window._initial_page;this.max_pages=1;this.pagination=window._pagination;this.postHTML=Handlebars.compile(this.postHTMLTemplate());this.paginationHTML=Handlebars.compile(this.paginationHTMLTemplate());this.is_mod=window._is_topic_mod;this.is_logged_in=window._is_logged_in;socket=io.connect('http://'+document.domain+':3000'+'');socket.on("connect",(function(_this){return function(){return socket.emit('join',"pm--"+topic.pk);};})(this));socket.on("console",function(data){return console.log(data);});socket.on("event",function(data){if(data.post!=null){if(topic.page===topic.max_pages){$("#post-container").append(topic.postHTML(data.post));return window.addExtraHTML($("#post-"+data.post._id));}else{topic.max_pages=Math.ceil(data.count/topic.pagination);return topic.page=topic.max_pages;}}});window.socket=socket;this.refreshPosts();if(window._can_edit!=null){this.inline_editor=new InlineEditor("#new-post-box","",false);this.inline_editor.onSave(function(html,text){return $.post("/messages/"+topic.pk+"/new-post",JSON.stringify({post:html,text:text}),(function(_this){return function(data){if(data.error!=null){topic.inline_editor.flashError(data.error);}\u000aif(data.success!=null){topic.inline_editor.clearEditor();socket.emit("event",{room:"pm--"+topic.pk,post:data.newest_post,count:data.count});if(topic.page===topic.max_pages){$("#post-container").append(topic.postHTML(data.newest_post));window.addExtraHTML($("#post-"+data.newest_post._id));if(topic.inline_editor!=null){if(topic.inline_editor.quill.getText().trim()!==""&&$("#new-post-box").find(".ql-editor").is(":focus")){return $("#new-post-box")[0].scrollIntoView();}}}else{topic.max_pages=Math.ceil(data.count/topic.pagination);topic.page=topic.max_pages;return topic.refreshPosts();}}};})(this));});}\u000a$("#post-container").delegate(".post-edit","click",function(e){var element,inline_editor,post_buttons,post_content;e.preventDefault();element=$(this);post_content=$("#post-"+element.data("pk"));post_buttons=$("#post-buttons-"+element.data("pk"));post_buttons.hide();inline_editor=new InlineEditor("#post-"+element.data("pk"),"/messages/"+topic.pk+"/edit-post/"+(element.data("pk")),true);inline_editor.onSave(function(html,text,edit_reason){return $.post("/messages/"+topic.pk+"/edit-post",JSON.stringify({pk:element.data("pk"),post:html,text:text}),function(data){if(data.error!=null){inline_editor.flashError(data.error);}\u000aif(data.success!=null){inline_editor.destroyEditor();post_content.html(data.html);window.addExtraHTML(post_content);return post_buttons.show();}});});return inline_editor.onCancel(function(html,text){inline_editor.destroyEditor();inline_editor.resetElementHtml();window.addExtraHTML($("#post-"+element.data("pk")));return post_buttons.show();});});$("nav.pagination-listing").delegate("#previous-page","click",function(e){var element;e.preventDefault();element=$(this);if(topic.page!==1){$(".change-page").parent().removeClass("active");topic.page--;return topic.refreshPosts();}});$("nav.pagination-listing").delegate("#next-page","click",function(e){var element;e.preventDefault();element=$(this);if(topic.page!==topic.max_pages){$(".change-page").parent().removeClass("active");topic.page++;return topic.refreshPosts();}});$("nav.pagination-listing").delegate(".change-page","click",function(e){var element;e.preventDefault();element=$(this);topic.page=parseInt(element.text());return topic.refreshPosts();});$("nav.pagination-listing").delegate("#go-to-end","click",function(e){var element;e.preventDefault();element=$(this);topic.page=parseInt(topic.max_pages);return topic.refreshPosts();});$("nav.pagination-listing").delegate("#go-to-start","click",function(e){var element;e.preventDefault();element=$(this);topic.page=1;return topic.refreshPosts();});popped=(indexOf.call(window.history,'state')>=0);initialURL=location.href;$(window).on("popstate",function(e){var initialPop;initialPop=!popped&&location.href===initialURL;popped=true;if(initialPop){return;}\u000areturn setTimeout(function(){return window.location=window.location;},200);});}\u000aTopic.prototype.paginationHTMLTemplate=function(){return"<ul class=\u005c"pagination\u005c">\u005cn  <li>\u005cn    <a href=\u005c"\u005c" aria-label=\u005c"Start\u005c" id=\u005c"go-to-start\u005c">\u005cn      <span aria-hidden=\u005c"true\u005c">Go to Start</span>\u005cn    </a>\u005cn  </li>\u005cn  <li>\u005cn    <a href=\u005c"\u005c" aria-label=\u005c"Previous\u005c" id=\u005c"previous-page\u005c">\u005cn      <span aria-hidden=\u005c"true\u005c">&laquo;</span>\u005cn    </a>\u005cn  </li>\u005cn  {{#each pages}}\u005cn  <li><a href=\u005c"\u005c" class=\u005c"change-page page-link-{{this}}\u005c">{{this}}</a></li>\u005cn  {{/each}}\u005cn  <li>\u005cn    <a href=\u005c"\u005c" aria-label=\u005c"Next\u005c" id=\u005c"next-page\u005c">\u005cn      <span aria-hidden=\u005c"true\u005c">&raquo;</span>\u005cn    </a>\u005cn  </li>\u005cn  <li>\u005cn    <a href=\u005c"\u005c" aria-label=\u005c"End\u005c" id=\u005c"go-to-end\u005c">\u005cn      <span aria-hidden=\u005c"true\u005c">Go to End</span>\u005cn    </a>\u005cn  </li>\u005cn</ul>";};Topic.prototype.postHTMLTemplate=function(){return"<li class=\u005c"list-group-item post-listing-info\u005c">\u005cn  <div class=\u005c"row\u005c">\u005cn    <div class=\u005c"col-xs-4 hidden-md hidden-lg\u005c">\u005cn      <a href=\u005c"/member/{{author_login_name}}\u005c"><img src=\u005c"{{user_avatar_60}}\u005c" width=\u005c"{{user_avatar_x_60}}\u005c" height=\u005c"{{user_avatar_y_60}}\u005c" class=\u005c"avatar-mini\u005c"></a>\u005cn    </div>\u005cn    <div class=\u005c"col-md-3 col-xs-8\u005c">\u005cn      {{#if author_online}}\u005cn      <b><span class=\u005c"glyphicon glyphicon-ok-sign\u005c" aria-hidden=\u005c"true\u005c"></span> <a href=\u005c"/member/{{author_login_name}}\u005c">{{author_name}}</a></b>\u005cn      {{else}}\u005cn      <b><span class=\u005c"glyphicon glyphicon-minus-sign\u005c" aria-hidden=\u005c"true\u005c"></span> <a href=\u005c"/member/{{author_login_name}}\u005c" class=\u005c"inherit_colors\u005c">{{author_name}}</a></b>\u005cn      {{/if}}\u005cn      {{#unless author_group_name}}\u005cn      <span style=\u005c"color:#F88379;\u005c"><strong>Members</strong></span><br>\u005cn      {{else}}\u005cn      {{group_pre_html}}{{author_group_name}}{{group_post_html}}\u005cn      {{/unless}}\u005cn      <span class=\u005c"hidden-md hidden-lg\u005c">Posted {{created}}</span>\u005cn    </div>\u005cn    <div class=\u005c"col-md-9 hidden-xs hidden-sm\u005c">\u005cn      <span id=\u005c"post-number-1\u005c" class=\u005c"post-number\u005c" style=\u005c"vertical-align: top;\u005c"><a href=\u005c"{{direct_url}}\u005c" id=\u005c"postlink-{{_id}}\u005c">\u005c#{{count}}</a></span>\u005cn      Posted {{created}}\u005cn    </div>\u005cn  </div>\u005cn</li>\u005cn<li class=\u005c"list-group-item post-listing-post\u005c">\u005cn  <div class=\u005c"row\u005c">\u005cn    <div class=\u005c"col-lg-3 col-md-4\u005c" style=\u005c"text-align: center;\u005c">\u005cn      <a href=\u005c"/member/{{author_login_name}}\u005c"><img src=\u005c"{{user_avatar}}\u005c" width=\u005c"{{user_avatar_x}}\u005c" height=\u005c"{{user_avatar_y}}\u005c" class=\u005c"post-member-avatar hidden-xs hidden-sm\u005c"></a>\u005cn      <span class=\u005c"hidden-xs hidden-sm\u005c"><br><br>\u005cn      <div class=\u005c"post-member-self-title\u005c">{{user_title}}</div>\u005cn        <hr></span>\u005cn      <div class=\u005c"post-meta\u005c">\u005cn      </div>\u005cn    </div>\u005cn    <div class=\u005c"col-lg-9 col-md-8 post-right\u005c">\u005cn      <div class=\u005c".post-content\u005c" id=\u005c"post-{{_id}}\u005c">\u005cn        {{{html}}}\u005cn      </div>\u005cn      <br>\u005cn      <div class=\u005c"row post-edit-likes-info\u005c" id=\u005c"post-buttons-{{_id}}\u005c">\u005cn          <div class=\u005c"col-md-8\u005c">\u005cn            {{#if _is_logged_in}}\u005cn            <div class=\u005c"btn-group\u005c" role=\u005c"group\u005c" aria-label=\u005c"...\u005c">\u005cn              <button type=\u005c"button\u005c" class=\u005c"btn btn-default\u005c">Report</button>\u005cn              <div class=\u005c"btn-group\u005c">\u005cn                <button type=\u005c"button\u005c" class=\u005c"btn btn-default\u005c">Reply</button>\u005cn                <button type=\u005c"button\u005c" class=\u005c"btn btn-default dropdown-toggle\u005c" data-toggle=\u005c"dropdown\u005c" aria-expanded=\u005c"false\u005c">\u005cn                  <span class=\u005c"caret\u005c"></span>\u005cn                  <span class=\u005c"sr-only\u005c">Toggle Dropdown</span>\u005cn                </button>\u005cn                <ul class=\u005c"dropdown-menu\u005c" role=\u005c"menu\u005c">\u005cn                  <li><a href=\u005c"\u005c">Quote</a></li>\u005cn                </ul>\u005cn              </div>\u005cn            {{/if}}\u005cn              <div class=\u005c"btn-group\u005c" style=\u005c"\u005c">\u005cn                {{#if _is_topic_mod}}\u005cn                <button type=\u005c"button\u005c" class=\u005c"btn btn-default\u005c">Options</button>\u005cn                <button type=\u005c"button\u005c" class=\u005c"btn btn-default dropdown-toggle\u005c" data-toggle=\u005c"dropdown\u005c" aria-expanded=\u005c"false\u005c">\u005cn                  <span class=\u005c"caret\u005c"></span>\u005cn                  <span class=\u005c"sr-only\u005c">Toggle Dropdown</span>\u005cn                </button>\u005cn                <ul class=\u005c"dropdown-menu\u005c" role=\u005c"menu\u005c">\u005cn                      <li><a href=\u005c"\u005c" class=\u005c"post-edit\u005c" data-pk=\u005c"{{_id}}\u005c">Edit</a></li>\u005cn                </ul>\u005cn                {{else}}\u005cn                  {{#if is_author}}\u005cn                    <button type=\u005c"button\u005c" class=\u005c"btn btn-default\u005c">Options</button>\u005cn                    <button type=\u005c"button\u005c" class=\u005c"btn btn-default dropdown-toggle\u005c" data-toggle=\u005c"dropdown\u005c" aria-expanded=\u005c"false\u005c">\u005cn                      <span class=\u005c"caret\u005c"></span>\u005cn                      <span class=\u005c"sr-only\u005c">Toggle Dropdown</span>\u005cn                    </button>\u005cn                    <ul class=\u005c"dropdown-menu\u005c" role=\u005c"menu\u005c">\u005cn                      <li><a href=\u005c"\u005c" class=\u005c"post-edit\u005c" data-pk=\u005c"{{_id}}\u005c">Edit</a></li>\u005cn                    </ul>\u005cn                  {{/if}}\u005cn                {{/if}}\u005cn              </div>\u005cn            </div>\u005cn        </div>\u005cn        <div class=\u005c"col-md-4 post-likes\u005c">\u005cn        </div>\u005cn      </div>\u005cn      <hr>\u005cn      <div class=\u005c"post-signature\u005c">\u005cn      </div>\u005cn    </div>";};Topic.prototype.refreshPosts=function(){var new_post_html;new_post_html="";return $.post("/messages/"+this.pk+"/posts",JSON.stringify({page:this.page,pagination:this.pagination}),(function(_this){return function(data){var first_post,i,j,k,l,len,m,n,pages,pagination_html,post,ref,ref1,ref2,ref3,ref4,ref5,ref6,results,results1,results2,results3;if(!_this.first_load){history.pushState({id:"pm-"+_this.pk+"-page-"+_this.page},'',"/messages/"+_this.pk+"/page/"+_this.page);}else{_this.first_load=false;}\u000afirst_post=((_this.page-1)*_this.pagination)+1;ref=data.posts;for(i=j=0,len=ref.length;j<len;i=++j){post=ref[i];post.count=first_post+i;post._is_topic_mod=_this.is_mod;post._is_logged_in=_this.is_logged_in;post.direct_url="/messages/"+_this.pk+"/page/"+_this.page+"/post/"+post._id;new_post_html=new_post_html+_this.postHTML(post);}\u000apages=[];_this.max_pages=Math.ceil(data.count/_this.pagination);if(_this.max_pages>5){if(_this.page>3&&_this.page<_this.max_pages-5){pages=(function(){results=[];for(var k=ref1=_this.page-2,ref2=_this.page+5;ref1<=ref2?k<=ref2:k>=ref2;ref1<=ref2?k++:k--){results.push(k);}\u000areturn results;}).apply(this);}else if(_this.page>3){pages=(function(){results1=[];for(var l=ref3=_this.page-2,ref4=_this.max_pages;ref3<=ref4?l<=ref4:l>=ref4;ref3<=ref4?l++:l--){results1.push(l);}\u000areturn results1;}).apply(this);}else if(_this.page<=3){pages=(function(){results2=[];for(var m=1,ref5=_this.page+5;1<=ref5?m<=ref5:m>=ref5;1<=ref5?m++:m--){results2.push(m);}\u000areturn results2;}).apply(this);}}else{pages=(function(){results3=[];for(var n=1,ref6=Math.ceil(data.count/_this.pagination);1<=ref6?n<=ref6:n>=ref6;1<=ref6?n++:n--){results3.push(n);}\u000areturn results3;}).apply(this);}\u000apagination_html=_this.paginationHTML({pages:pages});$(".pagination-listing").html(pagination_html);$("#post-container").html(new_post_html);$(".page-link-"+_this.page).parent().addClass("active");if(window._initial_post!==""){setTimeout(function(){$("#postlink-"+window._initial_post)[0].scrollIntoView();return window._initial_post="";},100);}else{setTimeout(function(){return $("#topic-breadcrumb")[0].scrollIntoView();},100);}\u000areturn window.setupContent();};})(this));};return Topic;})();return window.topic=new Topic($("#post-container").data("pk"));});}).call(this);
p1
.