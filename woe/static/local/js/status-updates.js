// Generated by CoffeeScript 1.9.3
(function() {
  $(function() {
    var Status;
    Status = (function() {
      function Status() {
        var status;
        this.id = $("#status").attr("data-id");
        status = this;
        this.replyHTML = Handlebars.compile(this.replyHTMLTemplate());
        this.refreshView();
        this.socket = io.connect('http://' + document.domain + ':3000' + '');
        this.socket.on("connect", (function(_this) {
          return function() {
            return _this.socket.emit('join', "status--" + _this.id);
          };
        })(this));
        this.socket.on("console", function(data) {
          return console.log(data);
        });
        this.socket.on("event", function(data) {
          if (data.reply != null) {
            console.log(data.reply);
            $("#status-replies").append(status.replyHTML(data.reply));
            return $("#status-replies").scrollTop($('#status-replies')[0].scrollHeight);
          }
        });
        $("#submit-reply").click(function(e) {
          e.preventDefault();
          return status.addReply();
        });
      }

      Status.prototype.addReply = function() {
        return $.post("/status/" + this.id + "/reply", JSON.stringify({
          reply: $("#status-reply").val()
        }), (function(_this) {
          return function(data) {
            $("#status-reply").val("");
            _this.socket.emit("event", {
              room: "status--" + _this.id,
              reply: data.newest_reply
            });
            $("#status-replies").append(_this.replyHTML(data.newest_reply));
            return $("#status-replies").scrollTop($('#status-replies')[0].scrollHeight);
          };
        })(this));
      };

      Status.prototype.replyHTMLTemplate = function() {
        return "<div class=\"status-reply\" data-id=\"{{pk}}\">\n  <div class=\"media-left\">\n    <img src=\"{{user_avatar}}\" width=\"{{user_avatar_x}}px\" height=\"{{user_avatar_y}}px\">\n  </div>\n  <div class=\"media-body\">\n    <p><a href=\"#\">{{user_name}}</a><span class=\"status-mod-controls\"></span>\n    <br>{{text}}\n    <br><span class=\"status-reply-time\">{{time}}</span></p>\n  </div>\n  <hr>\n</div>";
      };

      Status.prototype.refreshView = function(scrolldown) {
        if (scrolldown == null) {
          scrolldown = false;
        }
        return $.get("/status/" + this.id + "/replies", {}, (function(_this) {
          return function(response) {
            var comment, i, len, ref;
            $("#status-replies").html("");
            ref = response.replies;
            for (i = 0, len = ref.length; i < len; i++) {
              comment = ref[i];
              $("#status-replies").append(_this.replyHTML(comment));
            }
            if (scrolldown) {
              return $("#status-replies").scrollTop($('#status-replies')[0].scrollHeight);
            }
          };
        })(this));
      };

      return Status;

    })();
    return window.status_ = new Status();
  });

}).call(this);
